<?xml version='1.0'?>
    <!DOCTYPE rfc SYSTEM 'rfc2629.dtd' [
        <!ENTITY rfc2119 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml'>
        <!ENTITY rfc4271 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4271.xml'>
        <!ENTITY rfc4486 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4486.xml'>
        <!ENTITY rfc4760 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4760.xml'>
        <!ENTITY rfc5492 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5492.xml'>
        <!ENTITY rfc8174 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.8174.xml'>
        <!ENTITY rfc9000 PUBLIC '' 'http://xml.resource.org/public/rfc/bibxml/reference.RFC.9000.xml'>
        <!ENTITY I-D.chen-idr-bgp-over-quic PUBLIC ''
      'http://xml.resource.org/public/rfc/bibxml-ids/reference.I-D.draft-chen-idr-bgp-over-quic-00.xml'>
        <!ENTITY I-D.ietf-idr-bgp-multisession PUBLIC ''
      'http://xml.resource.org/public/rfc/bibxml-ids/reference.I-D.draft-ietf-idr-bgp-multisession-07.xml'>
        ]>
<?rfc toc="yes"?>
<?rfc tocompact="no"?>
<?rfc tocdepth="6"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<?rfc strict="yes" ?>
<rfc category="std" docName="draft-xxx-idr-bgp-quic-stream-00">
  <!-- ***** FRONT MATTER ***** -->
  <front>
    <title abbrev="BGP QUIC Streams">Use of Streams in BGP over QUIC</title>

    <author initials="A" surname="Retana"
    fullname="Alvaro Retana">
      <organization>Futurewei Technologies, Inc.</organization>

      <address>
        <postal>
          <street>2330 Central Expressway</street>
          <city>Santa Clara</city>
          <region>CA</region>
          <code>95050</code>
          <country>USA</country>
        </postal>
       <email>aretana@futurewei.com</email>
      </address>
    </author>

    <author fullname="Yingzhen Qu" initials="Y" surname="Qu">
      <organization>Futurewei Technologies, Inc.</organization>
      <address>
        <postal>
          <street>2330 Central Expressway</street>
          <city>Santa Clara</city>
          <region>CA</region>
          <code>95050</code>
          <country>USA</country>
        </postal>
        <phone></phone>
        <email>yingzhen.qu@futurewei.com</email>
      </address>
    </author>


    <date/>
    <area>Routing</area>
    <workgroup>IDR Workgroup</workgroup>
    <abstract>
      <t>
        This document specifies the use of QUIC Streams to support multiple BGP
        sessions over one connection in order to achieve high resiliency.
      </t>
    </abstract>
  </front>

  <!-- ***** MIDDLE MATTER ***** -->

  <middle>
    <section title="Introduction">
	  <t>
	    The Border Gateway Protocol (BGP) <xref target="RFC4271"/> uses TCP as
	    its transport protocol.  BGP establishes peer relationship between
      routers using a TCP session on port 179. TCP provides reliable packet
	    communication.
    </t>
    <t>
      Multiprotocol Extensions for BGP-4 (MP-BGP) <xref target="RFC4760"/>
      allow BGP to carry information for multiple Network Layer protocols.
      However, only a single TCP connection can reach the Established state
      with each peer <xref target="RFC4271"/>.
    </t>
    <t>
      As pointed out by <xref target="I-D.ietf-idr-bgp-multisession"/>, there
      are some disadvantages of using a single BGP session:
    <list style="empty">
      <t>
        A common criticism of BGP is the fact that most malformed messages
        cause the session to be terminated.  While this behavior is necessary
        for protocol correctness, one may observe that the protocol machinery
        of a given implementation may only be defective with respect to a
        given AFI/SAFI.  Thus, it would be desirable to allow the session
        related to that family to be terminated while leaving other AFI/SAFI
        unaffected.  As BGP is commonly deployed, this is not possible.
      </t>
      <t>
        A second criticism of BGP is that it is difficult or in some cases
        impossible to manage control plane resource contention when BGP is
        used to support diverse services over a single session.  In contrast,
        if a single BGP session carries only information for a single service
        (or related set of services) it may be easier to manage such
        contention.
      </t>
    </list></t>
    <t>
      QUIC <xref target="RFC9000"/> is an UDP-based multiplexed and secure
      transport protocol. QUIC can provide low latency and encrypted transport
      with resilient connections.  <xref target="I-D.chen-idr-bgp-over-quic"/>
      specifies the procedure to use BGP over QUIC. Complementary to it, this
      document specifies a mechanism to support BGP multisessions using QUIC
      streams.
	  </t>
    <t>
      Each session operates independently. An error on one session has
      no impact on any other session.  The BGP modification proposed
      in the document is limited to the OPEN exchange, mainly
      connection collision detection.
    </t>
    <t>
      Sessions are distinguished by the Network Layer protocol(s) negotiated
      in the OPEN message.  Multiple Network Layer protocol are negotiated
      using the Multiprotocol Extensions capability <xref target="RFC4760"/>.
    </t>

    <section title="Requirements Language">
       <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
        NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
        "MAY", and "OPTIONAL" in this document are to be interpreted as
        described in BCP 14 <xref target="RFC2119"/> <xref target="RFC8174"/>
        when, and only when, they appear in all capitals, as shown here.</t>
    </section>
    </section>


    <section title="BGP Multisessions">
      <section title="QUIC Multi-streams">
        <t>QUIC <xref target="RFC9000"/> is a UDP-based multiplexed and
          secure transport protocol.
          It provides connection-oriented and stateful interaction between
          a client and server. QUIC integrates TLS and allows the exchange
          of application data as soon as possible.</t>

        <t>In QUIC, application protocols exchange information via streams,
          and multiple streams can be multiplexed onto an underlying
          connection. Each stream is a separate unidirectional or
          bidirectional channel of "order stream of bytes".
          Each stream has flow control which limits bytes sent on a
          stream, together with flow control of the connection.</t>
      </section>
      <section title="Multiple BGP Sessions Using QUIC Streams">
        <t>
          BGP over QUIC <xref target="I-D.chen-idr-bgp-over-quic"/> proposes
          different options to map streams.  This document specifies a
          complementary and backwards compatible mechanism to achieve BGP
          multisessions using QUIC streams.  A simple implementation is to
          assign one Network Layer protocol to one BGP session, but it is
          possible to group multiple Network Layer protocols in one session.
        </t>
        <t>Connection Collision Detection procedure of the BGP specification
          <xref target="RFC4271"/> needs to be modified to allow using
          AFI/SAFI to determine the session uniqueness. Each BGP session
          operates independently, which means critical conditions (such
          as malformed message) in one session won't affect others.</t>
        <t>A QUIC stream is created by sending a BGP OPEN message, and
          each stream MUST be bidirectional as described in section 2.1
          of <xref target="RFC9000"/>. The MP-BGP capability in the OPEN
          message is used to identify the session. </t>
        <t>When a session needs to be terminated for some reason, both
          directions of the bidirectional stream MUST be terminated.</t>
      </section>
    </section>

    <section anchor="MSC" title="MultiStream Capability">
      <t>
       The MultiStream Capability (MSC) is defined to indicate that a BGP
       speaker supports multiple sessions as specified in this document.
       The capability <xref target="RFC5492"/> is defined as follows:

        <list style="empty">
          <t>Capability code (1 octet): TBD1</t>
          <t>Capability length (1 octet): 1 (TBC)</t>
          <t>Capability value (1 octet): flag field reserved.</t>
        </list></t>
        <figure title="" suppress-title="false" align="left" alt="" width="" height="">
        <artwork xml:space="preserve" name="" type="" align="left" alt="" width="" height="">
   0 1 2 3 4 5 6 7
  +-+-+-+-+-+-+-+-+
  |   Reserved    |
  +-+-+-+-+-+-+-+-+

        </artwork>
        </figure>
        <t>Reserved - MUST be set to zero by sender, MUST be ignored
          by receiver.</t>
        <t>
          The MSC applies only when BGP over QUIC
          <xref target="I-D.chen-idr-bgp-over-quic"/> is used.  It MUST be
          ignored otherwise.
        </t>
        <t>
          The specification in this document is used only if both peers
          advertise the MSC during the establishment of the "initial session".
          Otherwise the processes specified in
          <xref target="I-D.chen-idr-bgp-over-quic"/> MUST be followed.  In
          particular, if a peer that advertises the MSC doesn't receive an OPEN
          message with the MSC from its peer, it SHOULD NOT terminate the
          session.
        </t>
        <t>
          Using the MSC allows peers to establish multiple BGP sessions, one
          per QUIC stream.  Each new BGP session is established using its own
          OPEN message <xref target="RFC4271"/> and MUST include the MSC.  If
          the MSC was exchanged by both peers in the "initial session" but is
          not present when establishing a new session, the session is
          terminated and the Error Subcode MUST be set to MultiStream
          Conflict (TBD2).
        </t>
        <t>
          The MultiStream Capability SHOULD be enabled by default.
        </t>
        <t>
          Once a BGP session is established, it follows the procedures
          specified in <xref target="RFC4271"/>.</t>
    </section>

    <section anchor="notifications" title="Error Handling">
      <t>
        OPEN message error handling is defined in section 6.2 of
        <xref target="RFC4271"/>. This document introduces the following
        OPEN Message Error subcodes:
      <list style="empty">
        <t>
          TBD2 - MultiSession Conflict - Used if the MSC was exchanged by both peers in the "initial session" but is not present when establishing
          a new session.
        </t>
        <t>
          TBD3 - Session Capability Mismatch -  Used if a BGP speaker
          terminates a session on the case where it sends an OPEN message with
          the MSC, but receives an OPEN message without it.
        </t>
        <t>
          TBD4 - Network Layer Protocol Mismatch - Used if a BGP session has
          already been established for the signaled Network Layer Protocol,
          either explicitly or as a superset.
        </t>
      </list></t>
      <t>
        <xref target="MSC"/> recommends a BGP speaker to not terminate a
        session if it advertises the MSC but doesn't receive an OPEN message
        with the MSC from its peer.  If such a BGP speaker does terminate the
        session, the Error Subcode MUST be set to Session Capability Mismatch
        (TBD3).
      </t>
      <t>
        Using the MSC the peers MAY set up more than one session for a specific
        Network Layer protocol, or groups of protocols.  If this functionality
        is not enabled and a BGP speaker terminates the session, the Error
        Subcode MUST be set to Network Layer Protocol Mismatch (TBD4).
      </t>
      <t>
        Any individual BGP session can be terminated as specified in
        <xref target="RFC4486"/>.  If multiple sessions are to be terminated,
        then the procedure MUST be followed for each one.
      </t>
    </section>

    <section title="Connection and Collision">
      <t>To detect Connection Collision, base BGP protocol
        <xref target="RFC4271"/> uses only IP addresses
        as the sole consideration. BGP multisession proposed in this
        document also takes into account the AFI/SAFI carried in a
        session. A session is considered unique if the AFI/SAFI carried
        in the session is not carried in any other session.</t>
      <t>Before creating a new session, a BGP speaker should check that
        no session exists for the AFI/SAFI included in MP-BGP capability.
        If there is an existing session for any of the AFI/SAFI, a BGP
        speaker SHOULD NOT attempt to create a new session, and a local
        error may be logged.</t>
      <t>If BGP multisession is disabled or not supported on the local
        BGP speaker, and an OPEN message is received with MSC, the local
        BGP speaker will send an OPEN message without MSC.</t>
      <t>When BGP multisession is enabled, a BGP speaker MUST send OPEN
        message with MSC.</t>
      <t>Upon receiving of an OPEN message, if the local BGP speaker is
        set to run multisession but there is no session created yet,
        and the received OPEN message doesn't include MSC, the connection
        can proceed as if there is described in
        <xref target="I-D.chen-idr-bgp-over-quic"/>. If there are
        existing sessions created with MSC, then the local BGP speaker
        MUST close the session and send a NOTIFICATION as described in
        <xref target="notifications" format="default"/>.</t>
      <t>If a BGP speaker receives an OPEN message and there is already
        an existing session in ESTABLISHED state for any of the AFI/SAFI,
        it MUST ignore this OPEN message and close the session. A
        NOTIFICATION as described in <xref target="notifications"/>
        SHOULD be sent.</t>
      <t>Upon receiving of an OPEN message, if there is a session in
        OpenConfirm or OpenSent state and the two sessions are for the
        same AFI/SAFI, it is considered as a session collide, the
        procedure from section 6.8 of <xref target="RFC4271"/> MUST
        be applied, except the NOTOFICATION type.</t>
      <t>Upon receiving of an OPEN message, if there is no session
        exists for any of the AFI/SAFI carried in the MP-BGP Capability,
        the session will proceed when either of the following condition
        is met:
        <list style="empty">
        <t>This is only a single AFI/SAFI in the MP-BGP Capability,
          and the local BGP speaker also has this AFI/SAFI.</t>
        <t>There are multiple AFI/SAFIs in the MP-BGP Capability, and
          they match the local configuration of a group AFI/SAFIs to be
          combined in one session.</t>
        </list></t>
      <t>If neither of the conditions is met, a NOTIFICATION SHOULD be
        sent as described in <xref target="notifications"/>.</t>

    </section>

    <section title="Modifications to FSM">
      <t>This document does not modify BGP FSM except the collision
        handling procedure.
      </t>
    </section>

    <section title="Operational Considerations">
      <section title="Backford Compatibility">
        <t>For backward compatibility, it is important for multisession
        capable BGP speaker to be able to interoperate with BGP speakers
        which are not multisession capable. In such case, the BGP speaker
        should behave as described in <xref target="I-D.chen-idr-bgp-over-quic"/>
        and <xref target="RFC4271"/>.</t>
      </section>
      <section title="Session Prioritization">
        <t>One of the major drawbacks of a single session BGP is that
          packets from all AFI/SAFI are sent through this single session,
          and this may cause resource contention.</t>
        <t>QUIC <xref target="RFC9000"/> does not provide a mechanism
          or exchanging prioritization information. It relies on the
          application's receiving priority information and each QUIC
          stream is flow controlled independently. QUIC suggests an
          implementation SHOULD provide ways for an application to indicate
          the relative priority of streams. BGP sessions should be created
          using different priorities. For example, AFI/SAFI that carries
          routing information SHOUD be given higher priority and generous
          flow control.</t>
        <t>An implementation SHOULD support explicit configuration of
          session priorities.</t>
      </section>
      <section title="BGP Timers">
        <t>BGP timers are defined in section 10 of <xref target="RFC4271"/>.
        All BGP timers are maintained per session.</t>
        <t>Each stream session can use different HoldTime and KeepaliveTime.
          This can be done either through configuration or the value in
          the OPEN message. If an AFI/SAFI is not carrying critical routing
          information, slower timer may be used.</t>

      </section>
      <section title="Other Considerations">
      <t>A configuration command SHOULD be implemented to enable or
        disable multisession.</t>
      <t>A configuration command SHOULD be implemented to allow grouping
        of some AFI/SAFIs into one session.</t>
      <t>Implementations supporting multisession BGP SHOULD have show commands
        to view the state of each individual session, notifications and
        logs.</t>
      <t>It is up to the implementation to decide whether to handle
        such session in the same process or thread.</t>
      </section>
    </section>
    <section title="Security Considerations">
      <t>This document does not change the BGP security model.
      </t>
    </section>

    <section anchor="IANA" title="IANA Considerations">

      <t>
        IANA is asked to assign a new Capability Code for the MultiStream
        Capablity (<xref target="MSC"/>) as follows:
      </t>
        <texttable title="MultiStream Capability">
          <ttcol>Value</ttcol>
          <ttcol>Description</ttcol>
          <ttcol>Reference</ttcol>
          <ttcol>Change Controller</ttcol>
          <c>TBD1</c>
          <c>MultiStream Capability</c>
          <c>[This Document]</c>
          <c>IETF</c>
        </texttable>
      <t>
        IANA is asked to assign three values from the OPEN Message Error
        subcodes registrty as follows:
      </t>
      <texttable>
        <ttcol>Value</ttcol>
        <ttcol>Name</ttcol>
        <ttcol>Reference</ttcol>
        <c>TBD2</c> <c>MultiSession Conflicty</c> <c>[This Document]</c>
        <c>TBD3</c> <c>Session Capability Mismatch</c> <c>[This Document]</c>
        <c>TBD4</c> <c>Network Layer Protocol Mismatch</c><c>[This Document]</c>
      </texttable>
    </section>

    <section title="Acknowledgement">
      <t>This document references the text and procedures defined in
        <xref target="I-D.ietf-idr-bgp-multisession"/>, and we are grateful
        for their contributions.</t>
      <t>
      The authors would like to thank xx for review and comments.
      </t>
    </section>

</middle>

  <!--  *****BACK MATTER ***** -->

<back>
    <references title="Normative References">
        &rfc2119;
        &rfc4271;
        &rfc4486;
        &rfc4760;
        &rfc5492;
        &rfc8174;
        &rfc9000;
        &I-D.chen-idr-bgp-over-quic;
    </references>
    <references title="Informative References">
        &I-D.ietf-idr-bgp-multisession;

    </references>

</back>
</rfc>
